#!/bin/sh

# ============================================
# 1. main ë¸Œëœì¹˜ ì§ì ‘ push ë°©ì§€
# ============================================
current_branch=$(git symbolic-ref --short HEAD)

if [ "$current_branch" = "main" ]; then
  echo "âŒ main ë¸Œëœì¹˜ì— ì§ì ‘ pushí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
  echo "ğŸ’¡ PRì„ í†µí•´ mergeí•´ì£¼ì„¸ìš”."
  exit 1
fi

# ============================================
# 2. console.log ê²€ì‚¬
# ============================================
echo "ğŸ” console.log ê²€ì‚¬ ì¤‘..."

# stdinìœ¼ë¡œ ì „ë‹¬ëœ push ì •ë³´ë¥¼ ì½ì–´ì„œ push ë²”ìœ„ í™•ì¸
while read local_ref local_sha remote_ref remote_sha; do
  # ìƒˆ ë¸Œëœì¹˜ pushì¸ ê²½ìš° (remote_shaê°€ 0ìœ¼ë¡œë§Œ êµ¬ì„±)
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # origin/mainì´ ì¡´ì¬í•˜ë©´ ê·¸ê²ƒê³¼ ë¹„êµ, ì•„ë‹ˆë©´ ì „ì²´ ì»¤ë°‹ ê²€ì‚¬
    if git rev-parse --verify origin/main >/dev/null 2>&1; then
      range="origin/main..$local_sha"
    else
      range="$local_sha"
    fi
  else
    range="$remote_sha..$local_sha"
  fi

  # ë³€ê²½ëœ íŒŒì¼ì—ì„œ console.log ê²€ì‚¬ (ì£¼ì„ê³¼ ë¬¸ìì—´ ì œì™¸)
  files=$(git diff --name-only $range -- '*.ts' '*.tsx' '*.js' '*.jsx' 2>/dev/null || true)

  if [ -n "$files" ]; then
    for file in $files; do
      if [ -f "$file" ]; then
        # ì‹¤ì œ ì½”ë“œì—ì„œ console.log ê²€ì‚¬ (ì£¼ì„ ë¼ì¸ ì œì™¸)
        if grep -n "console\.log" "$file" 2>/dev/null | grep -v "^\s*//" | grep -v "^\s*\*" | grep -q "console\.log"; then
          echo "âŒ console.logê°€ í¬í•¨ëœ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤: $file"
          grep -n "console\.log" "$file" | grep -v "^\s*//" | grep -v "^\s*\*" | head -5
          echo ""
          echo "ğŸ’¡ console.logë¥¼ ì œê±°í•œ í›„ ë‹¤ì‹œ pushí•´ì£¼ì„¸ìš”."
          exit 1
        fi
      fi
    done
  fi
done

# ============================================
# 3. Lint ê²€ì‚¬
# ============================================
echo "ğŸ” Lint ê²€ì‚¬ ì¤‘..."
npm run lint

if [ $? -ne 0 ]; then
  echo "âŒ Lint ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ pushí•´ì£¼ì„¸ìš”."
  exit 1
fi

echo "âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼! Pushë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."