import { Inject, Injectable } from '@nestjs/common';
import { YjsDocReaderService } from '../collaboration/yjs-doc-reader.service';
import { ISectionBuilder, SECTION_BUILDERS } from './builders';

@Injectable()
export class MarkdownService {
  constructor(
    private readonly yjsDocReader: YjsDocReaderService,
    @Inject(SECTION_BUILDERS)
    private readonly builders: ISectionBuilder[],
  ) {}

  /**
   * í—¤ë” ì„¹ì…˜ ìƒì„± (ë¬¸ì„œ ìƒì„± ì¼ì‹œ)
   */
  private buildHeader(): string[] {
    const now = new Date();
    const formattedDate = now.toLocaleString('ko-KR', {
      year: 'numeric',
      month: 'numeric',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true,
    });

    return [`> **ë¬¸ì„œ ìƒì„± ì¼ì‹œ**: ${formattedDate}`, ''];
  }

  /**
   * ë¹ˆ ë‚´ìš©ì¼ ë•Œ í‘œì‹œí•  ë©”ì‹œì§€
   */
  private buildEmptyMessage(): string[] {
    return [
      '### ðŸš€ ì•„ì§ ìž‘ì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.',
      'ìœ„ì ¯ì„ ì¶”ê°€í•˜ì—¬ íŒ€ì˜ ê·œì¹™ì„ ì •ì˜í•´ë³´ì„¸ìš”!',
      '',
    ];
  }

  /**
   * í‘¸í„° ì„¹ì…˜ ìƒì„±
   */
  private buildFooter(): string[] {
    return ['*Generated by team.config*'];
  }

  /**
   * ì›Œí¬ìŠ¤íŽ˜ì´ìŠ¤ì˜ ëª¨ë“  ìœ„ì ¯ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜
   */
  generateMarkdown(workspaceId: string): string {
    const allWidgets = this.yjsDocReader.getWidgets(workspaceId);
    const markdownParts: string[] = [...this.buildHeader()];

    let hasContent = false;

    for (const builder of this.builders) {
      const widgets = allWidgets.filter((w) => w.type === builder.widgetType);
      if (widgets.length > 0) {
        hasContent = true;
        markdownParts.push(...builder.build(widgets));
      }
    }

    if (!hasContent) {
      markdownParts.push(...this.buildEmptyMessage());
    }

    markdownParts.push(...this.buildFooter());

    return markdownParts.join('\n');
  }
}
