import { Test, TestingModule } from '@nestjs/testing';

import { MarkdownService } from '../markdown.service';
import { IWidgetService, WIDGET_SERVICE } from '../../widget/widget.interface';

type MockWidgetService = {
  [P in keyof IWidgetService]: jest.Mock;
};

describe('MarkdownService', () => {
  let service: MarkdownService;
  let widgetServiceMock: MockWidgetService;
  const workspaceId = 'w1';

  beforeEach(async () => {
    widgetServiceMock = {
      create: jest.fn(),
      findAll: jest.fn(),
      findOne: jest.fn(),
      lock: jest.fn(),
      unlock: jest.fn(),
      getLockOwner: jest.fn(),
      unlockAllByUser: jest.fn(),
      update: jest.fn(),
      remove: jest.fn(),
      updateLayout: jest.fn(),
    };

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        MarkdownService,
        {
          provide: WIDGET_SERVICE,
          useValue: widgetServiceMock,
        },
      ],
    }).compile();

    service = module.get<MarkdownService>(MarkdownService);
    jest.useFakeTimers().setSystemTime(new Date('2024-01-01T12:00:00Z'));
  });

  afterEach(() => {
    jest.useRealTimers();
  });

  it('ëª¨ë“  ìœ„ì ¯ì´ ì—†ìœ¼ë©´ í—¤ë”, í‘¸í„°, ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë°˜í™˜í•œë‹¤.', async () => {
    widgetServiceMock.findAll.mockResolvedValue([]);

    const markdown = await service.generateMarkdown(workspaceId);

    expect(markdown).toContain(
      'ì•„ì§ ì ì€ ë‚´ìš©ì´ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤! ìœ„ì ¯ì— ë‚´ìš©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”! ğŸš€',
    );
    expect(markdown).toContain('*Generated by TeamConfig*');
  });
});
