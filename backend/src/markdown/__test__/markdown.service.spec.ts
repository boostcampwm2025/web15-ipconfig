import { Test, TestingModule } from '@nestjs/testing';

import { MarkdownService } from '../markdown.service';
import { IWidgetService, WIDGET_SERVICE } from '../../widget/widget.interface';
import { WidgetType } from '../../widget/dto/widget-content.dto';

type MockWidgetService = {
  [P in keyof IWidgetService]: jest.Mock;
};

describe('MarkdownService', () => {
  let service: MarkdownService;
  let widgetServiceMock: MockWidgetService;
  const workspaceId = 'w1';

  beforeEach(async () => {
    widgetServiceMock = {
      create: jest.fn(),
      findAll: jest.fn(),
      findOne: jest.fn(),
      lock: jest.fn(),
      unlock: jest.fn(),
      getLockOwner: jest.fn(),
      unlockAllByUser: jest.fn(),
      update: jest.fn(),
      remove: jest.fn(),
      updateLayout: jest.fn(),
    };

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        MarkdownService,
        {
          provide: WIDGET_SERVICE,
          useValue: widgetServiceMock,
        },
      ],
    }).compile();

    service = module.get<MarkdownService>(MarkdownService);
    jest.useFakeTimers().setSystemTime(new Date('2024-01-01T12:00:00Z'));
  });

  afterEach(() => {
    jest.useRealTimers();
  });

  it('ëª¨ë“  ìœ„ì ¯ì´ ì—†ìœ¼ë©´ í—¤ë”, í‘¸í„°, ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë°˜í™˜í•œë‹¤.', async () => {
    widgetServiceMock.findAll.mockResolvedValue([]);

    const markdown = await service.generateMarkdown(workspaceId);

    expect(markdown).toContain('# ðŸš€ Project Team Align Report');
    expect(markdown).toContain(
      'ì•„ì§ ì ì€ ë‚´ìš©ì´ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤! ìœ„ì ¯ì— ë‚´ìš©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”! ðŸš€',
    );
    expect(markdown).toContain('*Generated by TeamConfig*');
  });

  it('ê° ìœ„ì ¯ì„ ë§ˆí¬ë‹¤ìš´ ì„¹ì…˜ìœ¼ë¡œ ë³€í™˜í•œë‹¤', async () => {
    widgetServiceMock.findAll.mockResolvedValue([
      {
        widgetId: 'widget-1',
        type: WidgetType.GROUND_RULE,
        data: {
          x: 0,
          y: 0,
          width: 100,
          height: 100,
          zIndex: 1,
          content: {
            widgetType: WidgetType.GROUND_RULE,
            rules: ['Folder', 'Commit'],
          },
        },
      },
      {
        widgetId: 'widget-2',
        type: WidgetType.TECH_STACK,
        data: {
          x: 0,
          y: 0,
          width: 100,
          height: 100,
          zIndex: 1,
          content: {
            widgetType: WidgetType.TECH_STACK,
            selectedItems: [
              { id: '1', name: 'React', category: 'frontend' },
              { id: '2', name: 'NestJS', category: 'backend' },
            ],
          },
        },
      },
      {
        widgetId: 'widget-3',
        type: WidgetType.POST_IT,
        data: {
          x: 0,
          y: 0,
          width: 100,
          height: 100,
          zIndex: 1,
          content: {
            widgetType: WidgetType.POST_IT,
            text: 'ê¸°íƒ€ ë©”ëª¨',
            backgroundColor: '#fff',
            fontSize: 14,
          },
        },
      },
    ]);

    const markdown = await service.generateMarkdown(workspaceId);
    const lines = markdown.split('\n');

    // Ground Rule ì„¹ì…˜
    expect(lines).toContain('## 1. ðŸ“‹ Ground Rule');
    expect(lines).toContain('| Folder | - |');
    expect(lines).toContain('| Commit | - |');

    // Tech Stack ì„¹ì…˜
    expect(lines).toContain('## 2. ðŸ›  Tech Stack Selection');
    expect(lines).toContain('| React | vLatest |');
    expect(lines).toContain('| NestJS | vLatest |');

    // Else ì„¹ì…˜ (Post-it)
    expect(lines).toContain('## 3. Else');
    expect(lines).toContain('ê¸°íƒ€ ë©”ëª¨');
  });
});
