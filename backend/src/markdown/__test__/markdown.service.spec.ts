import { Test, TestingModule } from '@nestjs/testing';

import { MarkdownService } from '../markdown.service';
import { YjsDocReaderService } from '../../collaboration/yjs-doc-reader.service';
import type { YjsWidgetData } from '../../collaboration/types/yjs-widget.types';

describe('MarkdownService', () => {
  let service: MarkdownService;
  let yjsDocReaderMock: { getWidgets: jest.Mock };
  const workspaceId = 'w1';

  beforeEach(async () => {
    yjsDocReaderMock = {
      getWidgets: jest.fn(),
    };

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        MarkdownService,
        {
          provide: YjsDocReaderService,
          useValue: yjsDocReaderMock,
        },
      ],
    }).compile();

    service = module.get<MarkdownService>(MarkdownService);
    jest.useFakeTimers().setSystemTime(new Date('2024-01-01T12:00:00Z'));
  });

  afterEach(() => {
    jest.useRealTimers();
  });

  it('ëª¨ë“  ìœ„ì ¯ì´ ì—†ìœ¼ë©´ í—¤ë”, í‘¸í„°, ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë°˜í™˜í•œë‹¤.', () => {
    yjsDocReaderMock.getWidgets.mockReturnValue([]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain(
      'ì•„ì§ ì ì€ ë‚´ìš©ì´ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤! ìœ„ì ¯ì— ë‚´ìš©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”! ğŸš€',
    );
    expect(markdown).toContain('*Generated by TeamConfig*');
  });

  it('COLLABORATION ìœ„ì ¯ì´ ìˆìœ¼ë©´ í˜‘ì—… ê·œì¹™ ë§ˆí¬ë‹¤ìš´ì„ ìƒì„±í•œë‹¤.', () => {
    const collaborationWidget: YjsWidgetData = {
      widgetId: 'collab-1',
      type: 'COLLABORATION',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        prRules: {
          activeVersion: {
            selectedId: 'v1',
            options: { v1: { value: 'Semantic Versioning', createdAt: 0 } },
          },
          activeStrategy: {
            selectedId: 's1',
            options: { s1: { value: 'Squash and Merge', createdAt: 0 } },
          },
          labelRules: {
            selectedIds: ['l1', 'l2'],
            options: {
              l1: { value: 'bug', createdAt: 0 },
              l2: { value: 'feature', createdAt: 0 },
            },
          },
        },
        reviewPolicy: {
          approves: 2,
          maxReviewHours: 24,
          blockMerge: true,
        },
        workflow: {
          platform: {
            selectedId: 'p1',
            options: { p1: { value: 'GitHub Projects', createdAt: 0 } },
          },
          cycleValue: 2,
          cycleUnit: 'ì£¼',
        },
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([collaborationWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## ğŸ¤ í˜‘ì—… ê·œì¹™');
    expect(markdown).toContain('### PR ê·œì¹™');
    expect(markdown).toContain('Semantic Versioning');
    expect(markdown).toContain('Squash and Merge');
    expect(markdown).toContain('bug, feature');
    expect(markdown).toContain('### ë¦¬ë·° ì •ì±…');
    expect(markdown).toContain('2ëª…');
    expect(markdown).toContain('24ì‹œê°„');
    expect(markdown).toContain('### ì›Œí¬í”Œë¡œìš°');
    expect(markdown).toContain('GitHub Projects');
    expect(markdown).toContain('2ì£¼');
  });

  it('COMMUNICATION ìœ„ì ¯ì´ ìˆìœ¼ë©´ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë§ˆí¬ë‹¤ìš´ì„ ìƒì„±í•œë‹¤.', () => {
    const communicationWidget: YjsWidgetData = {
      widgetId: 'comm-1',
      type: 'COMMUNICATION',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        communication: {
          urgent: {
            selectedId: 'u1',
            options: { u1: { value: 'ì „í™”', createdAt: 0 } },
          },
          sync: {
            selectedId: 's1',
            options: { s1: { value: 'Zoom', createdAt: 0 } },
          },
          async: {
            selectedId: 'a1',
            options: { a1: { value: 'Slack', createdAt: 0 } },
          },
          official: {
            selectedId: 'o1',
            options: { o1: { value: 'ì´ë©”ì¼', createdAt: 0 } },
          },
        },
        sla: {
          responseTime: 24,
        },
        timeManagement: {
          coreTimeStart: '10:00',
          coreTimeEnd: '18:00',
        },
        meeting: {
          noMeetingDay: 'ìˆ˜ìš”ì¼',
          feedbackStyle: 'ì§ì ‘ì ',
        },
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([communicationWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## ğŸ’¬ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜');
    expect(markdown).toContain('### ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ìˆ˜ë‹¨');
    expect(markdown).toContain('ì „í™”');
    expect(markdown).toContain('Zoom');
    expect(markdown).toContain('Slack');
    expect(markdown).toContain('ì´ë©”ì¼');
    expect(markdown).toContain('### ì‘ë‹µ ì‹œê°„');
    expect(markdown).toContain('24ì‹œê°„ ì´ë‚´');
    expect(markdown).toContain('### ì½”ì–´ íƒ€ì„');
    expect(markdown).toContain('10:00 ~ 18:00');
    expect(markdown).toContain('### ë¯¸íŒ…');
    expect(markdown).toContain('ìˆ˜ìš”ì¼');
    expect(markdown).toContain('ì§ì ‘ì ');
  });
});
