import { Test, TestingModule } from '@nestjs/testing';

import { MarkdownService } from '../markdown.service';
import { YjsDocReaderService } from '../../collaboration/yjs-doc-reader.service';
import type { YjsWidgetData } from '../../collaboration/types/yjs-widget.types';

describe('MarkdownService', () => {
  let service: MarkdownService;
  let yjsDocReaderMock: { getWidgets: jest.Mock };
  const workspaceId = 'w1';

  beforeEach(async () => {
    yjsDocReaderMock = {
      getWidgets: jest.fn(),
    };

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        MarkdownService,
        {
          provide: YjsDocReaderService,
          useValue: yjsDocReaderMock,
        },
      ],
    }).compile();

    service = module.get<MarkdownService>(MarkdownService);
    jest.useFakeTimers().setSystemTime(new Date('2024-01-01T12:00:00Z'));
  });

  afterEach(() => {
    jest.useRealTimers();
  });

  it('Î™®Îì† ÏúÑÏ†ØÏù¥ ÏóÜÏúºÎ©¥ Ìó§Îçî, Ìë∏ÌÑ∞, ÏïàÎÇ¥ Î¨∏Íµ¨Î•º Î∞òÌôòÌïúÎã§.', () => {
    yjsDocReaderMock.getWidgets.mockReturnValue([]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('### üöÄ ÏïÑÏßÅ ÏûëÏÑ±Îêú ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
    expect(markdown).toContain('ÏúÑÏ†ØÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ ÌåÄÏùò Í∑úÏπôÏùÑ Ï†ïÏùòÌï¥Î≥¥ÏÑ∏Ïöî!');
    expect(markdown).toContain('*Generated by TeamConfig*');
  });

  it('COLLABORATION ÏúÑÏ†ØÏù¥ ÏûàÏúºÎ©¥ ÌòëÏóÖ Í∑úÏπô ÎßàÌÅ¨Îã§Ïö¥ÏùÑ ÏÉùÏÑ±ÌïúÎã§.', () => {
    const collaborationWidget: YjsWidgetData = {
      widgetId: 'collab-1',
      type: 'COLLABORATION',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        prRules: {
          activeVersion: {
            selectedId: 'v1',
            options: { v1: { value: 'Semantic Versioning', createdAt: 0 } },
          },
          activeStrategy: {
            selectedId: 's1',
            options: { s1: { value: 'Squash and Merge', createdAt: 0 } },
          },
          labelRules: {
            selectedIds: ['l1', 'l2'],
            options: {
              l1: { value: 'bug', createdAt: 0 },
              l2: { value: 'feature', createdAt: 0 },
            },
          },
        },
        reviewPolicy: {
          approves: 2,
          maxReviewHours: 24,
          blockMerge: true,
        },
        workflow: {
          platform: {
            selectedId: 'p1',
            options: { p1: { value: 'GitHub Projects', createdAt: 0 } },
          },
          cycleValue: 2,
          cycleUnit: 'Ï£º',
        },
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([collaborationWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## ü§ù ÌòëÏóÖ Í∑úÏπô');
    expect(markdown).toContain('### üîÄ Pull Request Í∑úÏπô');
    expect(markdown).toContain('Semantic Versioning');
    expect(markdown).toContain('Squash and Merge');
    expect(markdown).toContain('`bug`, `feature`');
    expect(markdown).toContain('### üßê Î¶¨Î∑∞ Ï†ïÏ±Ö (Review Policy)');
    expect(markdown).toContain('üõ°Ô∏è **2Î™Ö**');
    expect(markdown).toContain('‚è∞ **24h**');
    expect(markdown).toContain('üî¥ **YES**');
    expect(markdown).toContain('### üîÑ ÏõåÌÅ¨ÌîåÎ°úÏö∞ (Workflow)');
    expect(markdown).toContain('GitHub Projects');
    expect(markdown).toContain('2Ï£º');
  });

  it('COMMUNICATION ÏúÑÏ†ØÏù¥ ÏûàÏúºÎ©¥ Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò ÎßàÌÅ¨Îã§Ïö¥ÏùÑ ÏÉùÏÑ±ÌïúÎã§.', () => {
    const communicationWidget: YjsWidgetData = {
      widgetId: 'comm-1',
      type: 'COMMUNICATION',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        communication: {
          urgent: {
            selectedId: 'u1',
            options: { u1: { value: 'Ï†ÑÌôî', createdAt: 0 } },
          },
          sync: {
            selectedId: 's1',
            options: { s1: { value: 'Zoom', createdAt: 0 } },
          },
          async: {
            selectedId: 'a1',
            options: { a1: { value: 'Slack', createdAt: 0 } },
          },
          official: {
            selectedId: 'o1',
            options: { o1: { value: 'Ïù¥Î©îÏùº', createdAt: 0 } },
          },
        },
        sla: {
          responseTime: 24,
        },
        timeManagement: {
          coreTimeStart: '10:00',
          coreTimeEnd: '18:00',
        },
        meeting: {
          noMeetingDay: 'ÏàòÏöîÏùº',
          feedbackStyle: 'ÏßÅÏ†ëÏ†Å',
        },
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([communicationWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## üí¨ Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò');
    expect(markdown).toContain('### üì¢ Ï±ÑÎÑê Í∞ÄÏù¥Îìú');
    expect(markdown).toContain('Ï†ÑÌôî');
    expect(markdown).toContain('Zoom');
    expect(markdown).toContain('Slack');
    expect(markdown).toContain('Ïù¥Î©îÏùº');
    expect(markdown).toContain('### ‚è≥ ÏãúÍ∞Ñ Í¥ÄÎ¶¨ Î∞è ÎØ∏ÌåÖ');
    expect(markdown).toContain('ÏΩîÏñ¥ ÌÉÄÏûÑ (Core Time)');
    expect(markdown).toContain('`10:00` ~ `18:00`');
    expect(markdown).toContain('ÏµúÎåÄ ÏùëÎãµ ÏãúÍ∞Ñ (SLA)');
    expect(markdown).toContain('24h');
    expect(markdown).toContain('ÎØ∏ÌåÖ ÏóÜÎäî ÎÇ†');
    expect(markdown).toContain('ÏàòÏöîÏùº');
    expect(markdown).toContain('ÌîºÎìúÎ∞± Ïä§ÌÉÄÏùº');
    expect(markdown).toContain('ÏßÅÏ†ëÏ†Å');
  });

  it('TECH_STACK ÏúÑÏ†ØÏù¥ ÏûàÏúºÎ©¥ Í∏∞Ïà† Ïä§ÌÉù ÎßàÌÅ¨Îã§Ïö¥ÏùÑ ÏÉùÏÑ±ÌïúÎã§.', () => {
    const techStackWidget: YjsWidgetData = {
      widgetId: 'tech-1',
      type: 'TECH_STACK',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        subject: {
          selectedId: 's1',
          options: { s1: { value: 'Frontend', createdAt: 0 } },
        },
        techItems: [
          { id: 't1', name: 'React', category: 'Library' },
          { id: 't2', name: 'TypeScript', category: 'Language' },
        ],
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([techStackWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## üõ† Í∏∞Ïà† Ïä§ÌÉù');
    expect(markdown).toContain('### Frontend');
    expect(markdown).toContain('React');
    expect(markdown).toContain('TypeScript');
  });

  it('GIT_CONVENTION ÏúÑÏ†ØÏù¥ ÏûàÏúºÎ©¥ Í∑∏ÎùºÏö¥Îìú Î£∞ ÎßàÌÅ¨Îã§Ïö¥ÏùÑ ÏÉùÏÑ±ÌïúÎã§.', () => {
    const gitConventionWidget: YjsWidgetData = {
      widgetId: 'git-1',
      type: 'GIT_CONVENTION',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        strategy: {
          selectedId: 's1',
          options: { s1: { value: 'GITHUB_FLOW', createdAt: 0 } },
        },
        branchRules: {
          mainBranch: 'main',
          developBranch: 'develop',
          prefixes: {
            selectedIds: ['p1', 'p2'],
            options: {
              p1: { value: 'feat', createdAt: 0 },
              p2: { value: 'fix', createdAt: 0 },
            },
          },
        },
        commitConvention: {
          commitTypes: {
            selectedIds: ['c1'],
            options: { c1: { value: 'chore', createdAt: 0 } },
          },
        },
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([gitConventionWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## üêô Git Ïª®Î≤§ÏÖò');
    expect(markdown).toContain('### üß© Î∏åÎûúÏπò Ï†ÑÎûµ');
    expect(markdown).toContain('GitHub Flow');
    expect(markdown).toContain('### üåø Î∏åÎûúÏπò Í∑úÏπô');
    expect(markdown).toContain('main');
    expect(markdown).toContain('develop');
    expect(markdown).toContain('`feat`, `fix`');
    expect(markdown).toContain('### üìù Ïª§Î∞ã Ïª®Î≤§ÏÖò');
    expect(markdown).toContain('chore');
  });

  it('POST_IT ÏúÑÏ†ØÏù¥ ÏûàÏúºÎ©¥ Ìï¥Îãπ ÎÇ¥Ïö©ÏùÑ Ìè¨Ìï®ÌïúÎã§.', () => {
    const postItWidget: YjsWidgetData = {
      widgetId: 'post-1',
      type: 'POST_IT',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        text: 'Ï§ëÏöîÌïú Î©îÎ™®ÏûÖÎãàÎã§.',
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([postItWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## üìå Í∑∏ Ïô∏');
    expect(markdown).toContain('Ï§ëÏöîÌïú Î©îÎ™®ÏûÖÎãàÎã§.');
  });

  it('NAMING_CONVENTION ÏúÑÏ†ØÏù¥ ÏûàÏúºÎ©¥ ÎÑ§Ïù¥Î∞ç Ïª®Î≤§ÏÖò ÎßàÌÅ¨Îã§Ïö¥ÏùÑ ÏÉùÏÑ±ÌïúÎã§.', () => {
    const namingConventionWidget: YjsWidgetData = {
      widgetId: 'naming-1',
      type: 'NAMING_CONVENTION',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        frontend: {
          variable: 'camelCase',
          function: 'camelCase',
          component: 'PascalCase',
          constant: 'UPPER_SNAKE_CASE',
        },
        backend: {
          variable: 'camelCase',
          function: 'camelCase',
          class: 'PascalCase',
          constant: 'UPPER_SNAKE_CASE',
        },
        database: {
          table: 'snake_case',
          column: 'snake_case',
          index: 'idx_prefix',
          constraint: 'pk_prefix',
        },
        common: {
          utility: 'camelCase',
          constant: 'UPPER_SNAKE_CASE',
          type: 'PascalCase',
          enum: 'UPPER_SNAKE_CASE',
        },
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([namingConventionWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## üìù ÎÑ§Ïù¥Î∞ç Ïª®Î≤§ÏÖò');
    expect(markdown).toContain('### Frontend');
    expect(markdown).toContain('camelCase');
    expect(markdown).toContain('PascalCase');
    expect(markdown).toContain('### Backend');
    expect(markdown).toContain('### Database');
    expect(markdown).toContain('snake_case');
    expect(markdown).toContain('### Common');
    expect(markdown).toContain('Ïó¥Í±∞Ìòï');
  });

  it('FORMAT ÏúÑÏ†ØÏù¥ ÏûàÏúºÎ©¥ ÏΩîÎìú Ìè¨Îß∑ ÎßàÌÅ¨Îã§Ïö¥ÏùÑ ÏÉùÏÑ±ÌïúÎã§.', () => {
    const formatWidget: YjsWidgetData = {
      widgetId: 'format-1',
      type: 'FORMAT',
      layout: { x: 0, y: 0, width: 300, height: 300 },
      createdAt: Date.now(),
      content: {
        line: 80,
        useTabs: false,
        tabWidth: 2,
        semi: true,
        singleQuote: true,
        jsxSingleQuote: false,
        bracketSpacing: true,
        trailingComma: 'all',
        arrowParens: true,
        attributePerLine: true,
      } as Record<string, unknown>,
    };

    yjsDocReaderMock.getWidgets.mockReturnValue([formatWidget]);

    const markdown = service.generateMarkdown(workspaceId);

    expect(markdown).toContain('## ‚öôÔ∏è ÏΩîÎìú Ìè¨Îß∑ (Code Format)');
    expect(markdown).toContain('Ï§Ñ Í∏∏Ïù¥');
    expect(markdown).toContain('80');
    expect(markdown).toContain('ÌÉ≠ ÏÇ¨Ïö©');
    expect(markdown).toContain('Îì§Ïó¨Ïì∞Í∏∞ Ìè≠');
    expect(markdown).toContain('ÏÑ∏ÎØ∏ÏΩúÎ°†');
    expect(markdown).toContain('ÌôëÎî∞Ïò¥Ìëú');
    expect(markdown).toContain('ÌõÑÌñâ ÏâºÌëú');
    expect(markdown).toContain('all');
  });
});
